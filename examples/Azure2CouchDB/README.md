# Azure2Couch #
A simple example of a .NET Console application which reads rows in batches from Azure Table Storage and imports them into CouchDB / Cloudant via a JSON transformation step. 

This example does not cope with incremental export or pause / resume (e.g. if your Azure data is changing during the export) because implementations would have to be specific to you application / data model.

## Usage / building ##
Visual Studio 2012 is required to build the example.
Run setup-devenv.bat in the Azure.Storage.Libreration root directory to install the required dependencies from NuGet.

## Azure -> CouchDB migration considerations ##

### Tables ###

CouchDB has no concept of tables. However, you can choose to partition documents by using an index (similar to a materialized view in SQL parlance). 

For example, if your JSON documents contain the appropriate metadata (see DynamicTableEntityToCouchDBEntityConverter.cs in this example), you could define a view such as:

	{
		"_id" : "_design/azureTSSchema",
			"views" : {		
				"byTable" : {
					"map" : "function(doc) { if(doc.AzureMetaData) { emit([doc.AzureMetaData.Table, doc.AzureMetaData.PartitionKey, doc.AzureMetaData.RowKey], null); }}"
				}
			}
		}
	}

enabling you to fetch all documents by table:

	https://<database url>/_design/azureTSSchema/_view/byTable?startkey=[<table>]&endkey=[<table>,{},{}]&include_docs=true

by table / partition key:

	https://<database url>/_design/azureTSSchema/_view/byTable?startkey=[<table>,<partitionKey>]&endkey=[<table>,partitionKey>,{}]&include_docs=true

or by table / partition key / row key:

	https://<database url>/_design/azureTSSchema/_view/byTable?key=[<table>,<partitionKey>,<rowKey>]&include_docs=true

Probably you'll want to map table, partition key and row key to more domain-specific fields, but this kind of view may help during migration. 

### PartitionKey / RowKey vs _id ###

Each document in CouchDB must have an _id field, representing its unique identity within the database. If you don't assign one at insertion time, CouchDB will generate one for you (using a UUID).

In this example, the _id is generated by concatenating the table name, partition key and row key. Note that this is not guaranteed to be unique, so you should choose something appropriate to your data model. If you do not assign an _id then be aware that you will have to de-duplicate documents yourself in the event that you need to stop and restart the import.


## License ##
The MIT License (MIT)

Copyright (c) 2013 Cloudant

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.


